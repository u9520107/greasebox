{"version":3,"sources":["to5-instrumenter.js"],"names":[],"mappings":"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","file":"to5-instrumenter.js","sourceRoot":"/source/","sourcesContent":["import istanbul from 'istanbul';\nimport esprima from 'esprima-fb';\nimport sourceMap from 'source-map';\nimport path from 'path';\nimport fs from 'fs';\nimport to5 from '6to5';\n\nfunction createSourceMapConsumer(map) {\n  if (typeof map === 'string') {\n    map = JSON.parse(map);\n  }\n  return new sourceMap.SourceMapConsumer(map);\n}\n/**\n *  Istanbul instrumenter extention that compiles es6 source into es5 version\n *\n *  @class To5Instrumenter\n *  @extends instanbul.Instrumenter\n */\nclass To5Instrumenter extends istanbul.Instrumenter {\n  /**\n   *  @constructor\n   *  @param {object} opts - options passed to istanbul.Instrumenter\n   */\n  constructor(opts = {}) {\n    istanbul.Instrumenter.call(this, opts);\n  }\n  _compile(code, filename) {\n    var compiled = to5.transform(code, {\n      filename: filename,\n      sourceMap: true\n    });\n    return compiled;\n  }\n  _parse(code) {\n    var program = esprima.parse(code, {\n      loc: true,\n      range: true,\n      sourceType: 'module',\n      es5: true,\n      comment: true\n    });\n    return program;\n  }\n  instrumentSync(code, filename) {\n    var compiled = this._compile(code, filename);\n    var program = this._parse(compiled.code);\n    this._sourceMap = createSourceMapConsumer(compiled.map);\n    return this.instrumentASTSync(program, filename, code);\n  }\n  /**\n     * Fix the location using the source maps used to compile and generate the\n     *  code.\n     * @param {Object} location The location to fix.\n     */\n  _fixLocation(location) {\n    location.start = this._sourceMap.originalPositionFor(location.start);\n    location.end = this._sourceMap.originalPositionFor(location.end);\n    if (location.start.source !== this.coverState.path) {\n      location.start = {\n        line: 0,\n        column: 0\n      };\n      location.end = {\n        line: 0,\n        column: 0\n      };\n      location.skip = true;\n    }\n  }\n  getPreamble(sourceCode, emitUseStrict) {\n    if (this._sourceMap) {\n      var statementMap = this.coverState.statementMap, functionMap = this.coverState.fnMap, branchMap = this.coverState.branchMap, key = null, map = null;\n      for (key in statementMap) {\n        if (statementMap.hasOwnProperty(key)) {\n          map = statementMap[key];\n          this._fixLocation(map);\n        }\n      }\n      for (key in functionMap) {\n        if (functionMap.hasOwnProperty(key)) {\n          map = functionMap[key];\n          this._fixLocation(map.loc);\n        }\n      }\n      for (key in branchMap) {\n        if (branchMap.hasOwnProperty(key)) {\n          var locations = branchMap[key].locations;\n          for (var i = 0; i < locations.length; i++) {\n            this._fixLocation(locations[i]);\n          }\n        }\n      }\n    }\n    return super.getPreamble(sourceCode, emitUseStrict);\n  }\n}\nexport default To5Instrumenter;\n"]}